
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trail Nutrition Tracker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        input, select, button { margin: 5px; padding: 8px; font-size: 16px; }
        .section { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        .consumed { background-color: #c8f7c5; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        img.route { max-width: 100%; margin-top: 20px; }
        #summary { margin-top: 30px; padding: 10px; border: 2px solid #333; background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>Trail Nutrition Tracker</h1>

    <h2>Embed Strava Route</h2>
    <input type="text" id="stravaRouteUrl" placeholder="Paste Strava Route URL">
    <button onclick="embedStravaRoute()">Embed Route</button>
    <div id="stravaEmbed"></div>

    <h2>Add Nutrition Product</h2>
    <select id="category">
        <option value="Plain Water">Plain Water</option>
        <option value="Drink Mix">Drink Mix</option>
        <option value="Gels">Gels</option>
    </select>
    <input type="text" id="name" placeholder="Product Name">
    <input type="number" id="calories" placeholder="Calories">
    <input type="number" id="carbs" placeholder="Carbs (g)">
    <input type="number" id="sodium" placeholder="Sodium (mg)">
    <input type="number" id="ounces" placeholder="Ounces (only for Water/Mix)">
    <button onclick="addProduct()">Add Product</button>

    <h2>Create Race Section</h2>
    <input type="text" id="sectionName" placeholder="Section Name (e.g., Mile 0–5)">
    <button onclick="addSection()">Add Section</button>

    <button onclick="startRace()" style="margin-top:20px; padding:10px; font-size:18px;">Start Race</button>
    <div id="raceTimer" style="margin-top:10px; font-weight:bold;"></div>

    <div id="sections"></div>

    <button onclick="showSummary()" style="margin-top:30px; padding:10px; font-size:18px;">Race Complete</button>
    <div id="summary"></div>

    <script>
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        let sections = JSON.parse(localStorage.getItem('sections') || '[]');
        let raceStartTime = null;
        let raceEndTime = null;
        let timerInterval = null;

        function saveData() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('sections', JSON.stringify(sections));
        }

        function embedStravaRoute() {
            const url = document.getElementById('stravaRouteUrl').value;
            const match = url.match(/strava.com\/routes\/(\d+)/);
            if (match && match[1]) {
                const routeId = match[1];
                const embedCode = `
                    <div class="strava-embed-placeholder" data-embed-type="route" data-embed-id="${routeId}" data-style="standard" data-slippy="true"></div>
                    <script src="https://strava-embeds.com/embed.js"></script>
                `;
                document.getElementById('stravaEmbed').innerHTML = embedCode;
            } else {
                alert("Invalid Strava route URL. Please make sure it looks like https://www.strava.com/routes/1234567890");
            }
        }

        function addProduct() {
            const category = document.getElementById('category').value;
            const product = {
                category: category,
                name: document.getElementById('name').value,
                calories: parseFloat(document.getElementById('calories').value) || 0,
                carbs: parseFloat(document.getElementById('carbs').value) || 0,
                sodium: parseFloat(document.getElementById('sodium').value) || 0,
                ounces: (category === 'Plain Water' || category === 'Drink Mix') ? parseFloat(document.getElementById('ounces').value) || 0 : 0
            };
            products.push(product);
            saveData();
            alert('Product added!');
        }

        function addSection() {
            const name = document.getElementById('sectionName').value;
            const section = { name: name, items: [] };
            sections.push(section);
            saveData();
            renderSections();
        }

        function startRace() {
            raceStartTime = new Date();
            document.getElementById('raceTimer').textContent = 'Race started at ' + raceStartTime.toLocaleTimeString();
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = Math.floor((now - raceStartTime) / 1000);
                document.getElementById('raceTimer').textContent = 'Race Time: ' + Math.floor(elapsed / 60) + 'm ' + (elapsed % 60) + 's';
            }, 1000);
        }

        function renderSections() {
            const container = document.getElementById('sections');
            container.innerHTML = '';
            sections.forEach((section, index) => {
                const div = document.createElement('div');
                div.className = 'section';
                div.innerHTML = `<h3>${section.name}</h3>`;

                const select = document.createElement('select');
                products.forEach((p, i) => {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${p.category}: ${p.name}`;
                    select.appendChild(option);
                });
                const addBtn = document.createElement('button');
                addBtn.textContent = 'Add to Section';
                addBtn.onclick = () => {
                    const selectedIndex = select.value;
                    section.items.push({ ...products[selectedIndex], consumed: false, timestamp: null });
                    saveData();
                    renderSections();
                };
                div.appendChild(select);
                div.appendChild(addBtn);

                const table = document.createElement('table');
                table.innerHTML = '<tr><th>Category</th><th>Name</th><th>Calories</th><th>Carbs</th><th>Sodium</th><th>Ounces</th><th>Consumed</th></tr>';
                section.items.forEach((item, itemIndex) => {
                    const row = document.createElement('tr');
                    row.className = item.consumed ? 'consumed' : '';
                    row.innerHTML = `<td>${item.category}</td><td>${item.name}</td><td>${item.calories}</td><td>${item.carbs}</td><td>${item.sodium}</td><td>${item.ounces}</td>`;
                    const checkCell = document.createElement('td');
                    const checkBtn = document.createElement('button');
                    checkBtn.textContent = item.consumed ? '✓' : 'Mark Consumed';
                    checkBtn.onclick = () => {
                        item.consumed = true;
                        item.timestamp = new Date().toISOString();
                        saveData();
                        renderSections();
                    };
                    checkCell.appendChild(checkBtn);
                    row.appendChild(checkCell);
                    table.appendChild(row);
                });
                div.appendChild(table);
                container.appendChild(div);
            });
        }

        function showSummary() {
            clearInterval(timerInterval);
            raceEndTime = new Date();
            let totalCalories = 0, totalCarbs = 0, totalSodium = 0, totalOunces = 0;
            let hourlyStats = {};

            sections.forEach(section => {
                section.items.forEach(item => {
                    if (item.consumed && item.timestamp) {
                        const consumedTime = new Date(item.timestamp);
                        const hour = Math.floor((consumedTime - raceStartTime) / 3600000);
                        if (!hourlyStats[hour]) {
                            hourlyStats[hour] = { calories: 0, carbs: 0, sodium: 0, ounces: 0 };
                        }
                        hourlyStats[hour].calories += item.calories;
                        hourlyStats[hour].carbs += item.carbs;
                        hourlyStats[hour].sodium += item.sodium;
                        hourlyStats[hour].ounces += item.ounces || 0;

                        totalCalories += item.calories;
                        totalCarbs += item.carbs;
                        totalSodium += item.sodium;
                        totalOunces += item.ounces || 0;
                    }
                });
            });

            let summaryHTML = `
                <h3>Nutrition Summary</h3>
                <p><strong>Total Calories:</strong> ${totalCalories.toFixed(1)}</p>
                <p><strong>Total Carbs:</strong> ${totalCarbs.toFixed(1)} g</p>
                <p><strong>Total Sodium:</strong> ${totalSodium.toFixed(1)} mg</p>
                <p><strong>Total Ounces:</strong> ${totalOunces.toFixed(1)} oz</p>
                <h4>Hourly Breakdown</h4>
            `;
            for (const hour in hourlyStats) {
                const stats = hourlyStats[hour];
                summaryHTML += `<p><strong>Hour ${hour}:</strong> ${stats.calories.toFixed(1)} cal, ${stats.carbs.toFixed(1)} g carbs, ${stats.sodium.toFixed(1)} mg sodium, ${stats.ounces.toFixed(1)} oz</p>`;
            }

            document.getElementById('summary').innerHTML = summaryHTML;
        }

        renderSections();
    </script>
</body>
</html>
